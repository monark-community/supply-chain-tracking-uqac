version: '3.9'

services:
  # PostgreSQL Database (starts first)
  db:
    image: postgres:18
    restart: always
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
    ports:
      - "${DB_PORT_OUT}:${DB_PORT_IN}"  # Example: 5432:5432
    volumes:
      # Mount initialization scripts (like coffee.sql)
      - ./db-init:/docker-entrypoint-initdb.d
    # Expose container name for internal connection
    container_name: postgres-db

  # Backend (Node.js / Express)
  backend:
    build: ./backend
    restart: always
    command: npm run dev
    ports:
      - "5000:5000"  # Access backend at localhost:5000
    env_file:
      - .env
    depends_on:
      - db  # Ensure DB container starts first
    volumes:
      - ./backend:/app
      - /app/node_modules
    container_name: backend-service

  # Frontend (React)
  frontend:
    build: ./frontend
    restart: always
    command: npm run dev
    env_file:
      - .env
    ports:
      - "3000:3000"  # Access frontend at localhost:3000
    environment:
      NODE_ENV: development
    volumes:
      - ./frontend:/app
      - /app/node_modules
    container_name: frontend-service

  # PGAdmin for managing the PostgreSQL database
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    env_file:
      - .env
    ports:
      - "${PGADMIN_PORT_OUT}:${PGADMIN_PORT_IN}"  # Example: 8080:80
    container_name: pgadmin
    depends_on:
      - db